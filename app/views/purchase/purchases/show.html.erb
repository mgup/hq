<%= render partial: 'purchase/header' %>
<div class="page-header">
  <h3>Заявка
    <% if @purchase.date_registration.present? %>
        № <%= @purchase.id %> от <%= l(@purchase.date_registration) %> на сумму <%= @purchase.purchase_line_items.collect { |li| li.planned_sum.to_i }.sum  %> руб.
    <% else %>
        № <%= @purchase.id %> на сумму <%= @purchase.purchase_line_items.purchase_price(@purchase.id) %> руб.
    <% end %>
  </h3>
</div>
<div>поиск по товарным позициям</div>
<table class="table table-condensed">
  <thead>
  <tr>
    <th>Товар</th>
    <th>Обоснование</th>
    <th>По плану</th>
    <th>Срок</th>
    <th>Поставщик</th>
    <th>Остаток</th>
    <th>Договора</th>
    <th></th>
    <th></th>
  </tr>
  </thead>
  <tbody>
  <% if @purchase.purchase_line_items.any? %>
    <% @purchase.purchase_line_items.each do |line_item| %>
        <% if line_item.published == ['опубликован' 'законтрактирован', 'оплачен', 'поставлен'] %>
          <tr class="success">
            <td><%= line_item.purchase_goods.nil? ? '-' : line_item.purchase_goods.name %></td>
            <td><%= line_item.purchase_goods.nil? ? '-' : line_item.purchase_goods.demand %></td>
            <td><%= line_item.planned_sum %></td>
            <td><%= line_item.period %></td>
            <td><%= line_item.purchase_suppliers.nil? ? '-' : line_item.purchase_suppliers.name %></td>
            <td><%= line_item.purchase_contract_items.collect { |li| li.total_price.to_i }.sum  %></td>
            <td>
              <%= link_to edit_purchase_line_item_path(line_item), class: 'btn btn-warning', title: 'Изменить' do %>
                  <span class="glyphicon glyphicon-edit"></span>
              <% end %>
            </td>
            <td>
              <%= link_to purchase_line_item_path(line_item), class: 'btn btn-danger', title: 'Удалить',
                          method: :delete,
                          data: { confirm: 'Вы уверены? Запись будет удалена!' }  do %>
                  <span class="glyphicon glyphicon-remove"></span>
              <% end %>
            </td>
          </tr>
        <% else %>
          <tr>
            <td><%= line_item.purchase_goods.nil? ? '-' : line_item.purchase_goods.name %></td>
            <td><%= line_item.purchase_goods.nil? ? '-' : line_item.purchase_goods.demand %></td>
            <td><%= line_item.planned_sum %></td>
            <td><%= line_item.period %></td>
            <td><%= line_item.purchase_suppliers.nil? ? '-' : line_item.purchase_suppliers.name %></td>
            <td><%= line_item.purchase_contract_items.collect { |li| li.total_price.to_i }.sum  %></td>
            <td>
              <%= link_to edit_purchase_line_item_path(line_item), class: 'btn btn-warning', title: 'Изменить' do %>
                  <span class="glyphicon glyphicon-edit"></span>
              <% end %>
            </td>
            <td>
              <%= link_to purchase_line_item_path(line_item), class: 'btn btn-danger', title: 'Удалить',
                          method: :delete,
                          data: { confirm: 'Вы уверены? Запись будет удалена!' }  do %>
                  <span class="glyphicon glyphicon-remove"></span>
              <% end %>
            </td>
          </tr>
        <% end %>
    <% end %>
  <% else %>
    <p>Товары отсутствуют</p>
  <% end %>
  </tbody>
</table>

<%= link_to 'Распечатать', purchase_purchase_path(format: 'xlsx'), class: 'btn btn-info' %>

<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal">
  Посмотреть статистику
</button>
<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Статистика</h4>
      </div>
      <div class="modal-body">
          <%#= render partial: 'statistics' %>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Закрыть</button>
      </div>
    </div>
  </div>
</div>
